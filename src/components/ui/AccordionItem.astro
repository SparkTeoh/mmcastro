---
// AccordionItem component for MMC Astro
// Based on SparkAstro's AccordionItem component but adapted for MMC's style

type Props = {
  index: number;
  title: string;
  description: string;
};

const { index, title, description } = Astro.props;
---

<div
  id="accordion__item"
  class="accordion__item group h-[120px] bg-white overflow-hidden w-full transition-all duration-500 mb-6 rounded-lg border border-gray-200 shadow-sm hover:shadow-md"
>
  <button
    class="accordion__toggle w-full h-[120px] flex items-center justify-between p-6 cursor-pointer"
    id={`${title} accordion__item menu button`}
    aria-expanded="false"
    aria-controls={`${title} accordion__item menu content`}
  >
    <div class="flex items-center gap-4 text-primary">
      <span class="hidden sm:block sm:text-4xl font-bold text-primary">0{index}</span>
      <span class="text-lg font-semibold text-primary">{title}</span>
    </div>
    <div
      class="bg-primary w-12 h-12 flex justify-center items-center rounded-full"
    >
      <div
        class="accordion__icon h-6 w-6 transition-transform duration-300 flex justify-center items-center relative"
        aria-hidden="true"
      >
      </div>
    </div>
  </button>
  <div
    id={`${title} accordion__item menu content`}
    aria-labelledby={`${title} accordion__item menu button `}
    class="accordion__content px-6"
  >
    <div class="w-full h-[1px] bg-primary"></div>
    <p class="prose mb-4 mt-4 max-w-full pt-4 pb-6 transition-[height] text-text-default leading-relaxed">
      {description}
    </p>
  </div>
</div>

<style>
  .accordion__icon::before,
  .accordion__icon::after {
    content: "";
    position: absolute;
    background-color: white;
    transition: opacity 0.3s ease;
  }

  .accordion__icon::before {
    width: 100%;
    height: 3px;
    left: 0;
    top: calc(50% - 1.5px);
  }

  .accordion__icon::after {
    width: 3px;
    height: 100%;
    left: calc(50% - 1.5px);
    top: 0;
  }

  .accordion__icon.collapsed::after {
    opacity: 0;
  }

  /* 当accordion展开时（有bg-accent类），改变样式 */
  .accordion__item.bg-accent .accordion__toggle {
    color: #024340;
  }

  .accordion__item.bg-accent .accordion__content p {
    color: #024340;
  }

  .accordion__item.bg-accent .accordion__icon::before,
  .accordion__item.bg-accent .accordion__icon::after {
    background-color: white;
  }

  .accordion__item.bg-accent .accordion__content div {
    background-color: #024340;
  }

  .accordion__item.bg-accent {
    background-color: #f8fafc;
    border-color: #024340;
  }
</style>

<script>
  function accordionSetup() {
    const accordionItems = document.querySelectorAll(
      ".accordion__item"
    ) as NodeListOf<HTMLElement>;

    accordionItems.forEach((accordionItem) => {
      const accordionToggle = accordionItem.querySelector(".accordion__toggle");
      const accordionIcon = accordionItem.querySelector(".accordion__icon");

      if (accordionToggle && accordionIcon) {
        accordionToggle.addEventListener("click", (e) => {
          e.stopPropagation();

          // Close other accordion items
          accordionItems.forEach((otherAccordionItem) => {
            if (
              otherAccordionItem !== accordionItem &&
              otherAccordionItem.classList.contains("active")
            ) {
              const otherAccordionToggle =
                otherAccordionItem.querySelector(".accordion__toggle");
              const otherAccordionIcon =
                otherAccordionItem.querySelector(".accordion__icon");

              if (otherAccordionToggle && otherAccordionIcon) {
                otherAccordionItem.classList.remove("active");
                otherAccordionItem.classList.remove("bg-accent");
                otherAccordionItem.classList.add("bg-white");
                otherAccordionToggle.setAttribute("aria-expanded", "false");
                otherAccordionItem.style.height = "120px";
                otherAccordionIcon.classList.remove("rotate-180");
                otherAccordionIcon.classList.remove("collapsed");
              }
            }
          });

          // Toggle current accordion item
          if (!accordionItem.classList.contains("active")) {
            accordionItem.classList.add("active");
            accordionToggle.setAttribute("aria-expanded", "true");

            // Set height according to content
            accordionItem.style.height = accordionItem.scrollHeight + "px";
            accordionItem.classList.remove("bg-white");
            accordionItem.classList.add("bg-accent");
            accordionIcon.classList.add("rotate-180");
            accordionIcon.classList.add("collapsed");
          } else {
            accordionItem.classList.remove("active");
            accordionToggle.setAttribute("aria-expanded", "false");

            // Reset height
            accordionItem.style.height = "120px";
            accordionIcon.classList.remove("rotate-180");
            accordionItem.classList.remove("bg-accent");
            accordionItem.classList.add("bg-white");
            accordionIcon.classList.remove("collapsed");
          }

          e.preventDefault();
          return false;
        });
      }
    });

    // Close the accordion when clicking outside of it
    document.addEventListener("click", (event) => {
      accordionItems.forEach((accordionItem) => {
        const accordionToggle =
          accordionItem.querySelector(".accordion__toggle");
        const accordionIcon = accordionItem.querySelector(".accordion__icon");

        if (
          accordionToggle &&
          accordionIcon &&
          !accordionItem.contains(event.target as Node)
        ) {
          accordionItem.classList.remove("active");
          accordionItem.classList.remove("bg-accent");
          accordionItem.classList.add("bg-white");
          accordionToggle.setAttribute("aria-expanded", "false");

          // Reset height
          accordionItem.style.height = "120px";
          accordionIcon.classList.remove("rotate-180");
          accordionIcon.classList.remove("collapsed");
        }
      });
    });
  }

  // Run on page swap
  accordionSetup();
  document.addEventListener("astro:after-swap", accordionSetup);
</script>
